<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENE-LOG - The Final Integration</title>
    <style>
        :root {
            --seiryu-blue: #00e5ff; --deep-blue: #001a33;
            --person: #e91e63; --agri: #4CAF50; --skill: #673AB7; --space: #FF9800;
            --header-h: 65px; --nav-h: 75px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; font-family: 'Hiragino Mincho ProN', serif; overflow: hidden; background: var(--deep-blue); }

        /* --- UI Layers --- */
        #setup-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
        
        header { 
            position: fixed; top: 0; width: 100%; height: var(--header-h); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            display: flex; flex-direction: column; justify-content: center; z-index: 3000; border-bottom: 1px solid #ddd;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; width: 100%; }
        .layer-bar { display: flex; gap: 5px; padding: 5px 15px; overflow-x: auto; scrollbar-width: none; }
        .chip { padding: 3px 10px; border-radius: 12px; font-size: 0.6rem; border: 1px solid #ccc; background: white; white-space: nowrap; opacity: 0.4; }
        .chip.active { opacity: 1; color: white; border-color: transparent; }

        .view { display: none; width: 100%; height: calc(100vh - var(--header-h) - var(--nav-h)); margin-top: var(--header-h); position: relative; overflow-y: auto; background: #f0f4f8; }
        .view.active { display: block; }

        /* --- Home (Map) --- */
        #home-view { background: #07192f url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&q=80&w=2000') center/cover; }
        .node { position: absolute; transform: translate(-50%, -50%); transition: 0.4s; }
        .node--scale { width: 44px; height: 48px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

        /* --- Input Modal --- */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 8000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-inner { width: 90%; max-width: 400px; background: white; border-radius: 25px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .mode-sw { display: flex; background: #eee; border-radius: 20px; padding: 3px; margin-bottom: 15px; }
        .mode-btn { flex: 1; border: none; padding: 8px; border-radius: 18px; font-size: 0.7rem; background: none; }
        .mode-btn.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sphere-sel { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .sphere-btn { width: 40px; height: 40px; border-radius: 50%; border: none; opacity: 0.3; color: white; font-size: 0.6rem; }
        .sphere-btn.active { opacity: 1; transform: scale(1.1); }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; font-size: 1rem; }

        /* --- KUKAI Dialogue --- */
        #ryuo-view { background: radial-gradient(circle at 50% 100%, #003366 0%, #000 100%); display: flex; flex-direction: column; }
        .chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 120px; }
        .bubble-ryuo { align-self: flex-start; max-width: 85%; background: rgba(255,255,255,0.1); border-radius: 20px 20px 20px 0; padding: 12px; font-size: 0.85rem; border: 1px solid rgba(0,229,255,0.2); color: white; }
        .bubble-user { align-self: flex-end; max-width: 80%; background: var(--seiryu-blue); color: var(--deep-blue); border-radius: 20px 20px 0 20px; padding: 10px 15px; font-size: 0.85rem; font-weight: bold; }
        .kukai-footer { position: absolute; bottom: 30px; width: 90%; left: 5%; background: rgba(0,40,80,0.9); border: 1px solid var(--seiryu-blue); border-radius: 40px; padding: 5px; display: flex; gap: 5px; backdrop-filter: blur(10px); }

        /* --- Archive --- */
        #archive-overlay { position: fixed; inset: 0; background: rgba(0,20,40,0.98); z-index: 9000; display: none; flex-direction: column; padding: 80px 20px 20px; }

        /* --- Floating Action Button --- */
        .fab { position: fixed; bottom: 95px; right: 20px; width: 60px; height: 60px; background: var(--seiryu-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--deep-blue); z-index: 3500; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* --- Footer Nav --- */
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-h); background: var(--deep-blue); display: flex; align-items: center; z-index: 4000; padding-bottom: 15px; }
        .nav-btn { flex: 1; color: white; border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; opacity: 0.4; }
        .nav-btn.active { opacity: 1; color: var(--seiryu-blue); }

        .ripple { position: absolute; border: 2px solid var(--seiryu-blue); border-radius: 50%; transform: translate(-50%, -50%); animation: rippleOut 1.2s ease-out forwards; opacity: 0; pointer-events: none; z-index: 5000; }
        @keyframes rippleOut { 0% { width:0; height:0; opacity:0.8; } 100% { width:150vmax; height:150vmax; opacity:0; } }
    </style>
</head>
<body>

    <div id="setup-layer" onclick="initApp()">
        <div><div style="font-size: 50px;">ğŸ‰</div><p>ã‚¿ãƒƒãƒ—ã—ã¦é–€ã‚’é–‹ã</p></div>
    </div>

    <div id="modal">
        <div class="modal-inner">
            <div class="mode-sw">
                <button id="m-give" onclick="setMode('give')" class="mode-btn active">ğŸ¥˜ æŒã¡å¯„ã‚Š</button>
                <button id="m-want" onclick="setMode('want')" class="mode-btn">ğŸ½ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
            </div>
            <div class="sphere-sel">
                <button id="b-person" onclick="setSphere('person')" class="sphere-btn active" style="background:var(--person)">äºº</button>
                <button id="b-agri" onclick="setSphere('agri')" class="sphere-btn" style="background:var(--agri)">è¾²</button>
                <button id="b-skill" onclick="setSphere('skill')" class="sphere-btn" style="background:var(--skill)">æ™ºæ…§</button>
                <button id="b-space" onclick="setSphere('space')" class="sphere-btn" style="background:var(--space)">å ´</button>
            </div>
            <input type="text" id="in-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <textarea id="in-desc" rows="3" placeholder="è©³ç´°ãƒ»æƒ³ã„"></textarea>
            <button onclick="saveItem()" style="width:100%; padding:15px; background:var(--deep-blue); color:white; border-radius:30px; border:none; font-weight:bold;">ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç½®ã</button>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#999; margin-top:10px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <header>
        <div class="header-top">
            <div style="font-weight:bold; font-size:0.75rem; color:var(--deep-blue);">ğŸ’  ENE-LOG</div>
            <button id="arc-btn" style="display:none; background:none; border:1px solid var(--seiryu-blue); color:var(--seiryu-blue); padding:4px 12px; border-radius:15px; font-size:0.6rem;" onclick="toggleArchive()">ğŸ“œ è¨˜éŒ²</button>
        </div>
        <div class="layer-bar" id="layer-chips">
            <div class="chip active" style="background:var(--person)" onclick="toggleLayer('person',this)">ğŸ‘¤ äºº</div>
            <div class="chip active" style="background:var(--agri)" onclick="toggleLayer('agri',this)">ğŸŒ± è¾²</div>
            <div class="chip active" style="background:var(--skill)" onclick="toggleLayer('skill',this)">ğŸ’¡ æ™ºæ…§</div>
            <div class="chip active" style="background:var(--space)" onclick="toggleLayer('space',this)">ğŸ  å ´</div>
        </div>
    </header>

    <div id="home-view" class="view active"><div id="map-area" style="width:100%; height:100%;"></div></div>
    <div id="table-view" class="view">
        <div class="table-container">
            <div class="table-col"><div style="font-size:0.7rem; font-weight:bold; border-bottom:1px solid #ddd; margin-bottom:10px;">ğŸ¥˜ æŒã¡å¯„ã‚Š</div><div id="list-give"></div></div>
            <div class="table-col"><div style="font-size:0.7rem; font-weight:bold; border-bottom:1px solid #ddd; margin-bottom:10px;">ğŸ½ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div><div id="list-want"></div></div>
        </div>
    </div>
    <div id="ryuo-view" class="view">
        <div class="chat-container" id="chat-box"><div class="bubble-ryuo">ã‚„ã‚ã€‚ä½•ã‹å¿ƒã«æµ®ã‹ã‚“ã ã€Œå•ã„ã€ã¯ã‚ã‚‹ã‹ãªï¼Ÿ</div></div>
        <div class="kukai-footer">
            <button class="lucky-btn" onclick="drawLucky()">å </button>
            <input type="text" id="kukai-input" placeholder="KUKAIã«å•ã†..." onkeypress="if(event.key==='Enter') sendKukai()">
            <button onclick="sendKukai()" style="background:var(--seiryu-blue); border:none; width:40px; height:40px; border-radius:50%; font-weight:bold;">å•</button>
        </div>
    </div>

    <div id="archive-overlay">
        <h3 style="color:var(--seiryu-blue); text-align:center; margin-bottom:20px;">æ™ºæ…§ã®è¨˜éŒ²</h3>
        <div id="arch-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="toggleArchive()" style="background:var(--seiryu-blue); border:none; width:100%; padding:15px; border-radius:30px; margin-top:15px;">é–‰ã˜ã‚‹</button>
    </div>

    <button class="fab" id="fab" onclick="openModal()">ï¼‹</button>

    <nav>
        <button class="nav-btn active" onclick="switchView('home-view', this)">ğŸ—º<span>Map</span></button>
        <button class="nav-btn" onclick="switchView('table-view', this)">ğŸ¥˜<span>Table</span></button>
        <button class="nav-btn" onclick="switchView('ryuo-view', this)">ğŸ²<span>KUKAI</span></button>
    </nav>

<script>
    let audioCtx, mMode='give', mSphere='person', activeL=['person','agri','skill','space'], history=[];
    let db = [
        { type:'person', icon:'ğŸ‘¤', title:'èŒ‚è°· å¹¸å¼˜', x:25, y:35, mode:'give', desc:'æ¡ˆå†…äºº' },
        { type:'agri', icon:'ğŸŒ±', title:'ç´è±†èŒå®Ÿé¨“', x:60, y:50, mode:'want', desc:'å”åŠ›æ±‚ã‚€' }
    ];

    function initApp() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); document.getElementById('setup-layer').style.display='none'; render(); }
    
    function switchView(id, btn) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('arc-btn').style.display = (id==='ryuo-view')?'block':'none';
        document.getElementById('fab').style.display = (id==='ryuo-view')?'none':'flex';
        render();
    }

    function playP() {
        const n=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(1100,n); o.frequency.exponentialRampToValueAtTime(1700,n+0.05);
        g.gain.setValueAtTime(0.4,n); g.gain.exponentialRampToValueAtTime(0.001,n+0.8);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(n+0.8);
        const r=document.createElement('div'); r.className='ripple'; r.style.top='50%'; r.style.left='50%';
        document.body.appendChild(r); setTimeout(()=>r.remove(),1200);
    }

    function openModal() { document.getElementById('modal').style.display='flex'; }
    function closeModal() { document.getElementById('modal').style.display='none'; }
    function setMode(m) { mMode=m; document.getElementById('m-give').className=m==='give'?'mode-btn active':'mode-btn'; document.getElementById('m-want').className=m==='want'?'mode-btn active':'mode-btn'; }
    function setSphere(s) { mSphere=s; document.querySelectorAll('.sphere-btn').forEach(b=>b.classList.remove('active')); document.getElementById('b-'+s).classList.add('active'); }

    function saveItem() {
        const t=document.getElementById('in-title').value; if(!t){alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ã­'); return;}
        db.unshift({type:mSphere, icon:document.getElementById('b-'+mSphere).innerText, title:t, desc:document.getElementById('in-desc').value, mode:mMode, x:20+Math.random()*60, y:20+Math.random()*60});
        document.getElementById('in-title').value=''; document.getElementById('in-desc').value='';
        closeModal(); playP(); render();
    }

    function toggleLayer(type, btn) {
        if(activeL.includes(type)) activeL=activeL.filter(l=>l!==type); else activeL.push(type);
        btn.classList.toggle('active'); render();
    }

    function sendKukai() {
        const i=document.getElementById('kukai-input'), t=i.value.trim(); if(!t)return;
        playP(); addB(t,'user'); i.value='';
        setTimeout(()=>{
            const r="å›ãŒè¦³æ¸¬ã—ãŸã“ã¨ã§ã€æ–°ã—ã„å¯èƒ½æ€§ãŒå½¢ã«ãªã£ãŸã­ã€‚ç´ æ•µã ã‚ˆï¼";
            addB(r,'ryuo'); history.unshift({q:t, a:r, d:new Date().toLocaleTimeString()});
        },1000);
    }
    function addB(t,type) { 
        const b=document.getElementById('chat-box'), d=document.createElement('div');
        d.className=type==='user'?'bubble-user':'bubble-ryuo'; d.innerText=t; b.appendChild(d); b.scrollTop=b.scrollHeight;
    }
    function toggleArchive() {
        const o=document.getElementById('archive-overlay'); o.style.display=o.style.display==='flex'?'none':'flex';
        document.getElementById('arch-list').innerHTML=history.map(h=>`<div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:10px; border-left:3px solid var(--seiryu-blue); font-size:0.7rem;"><div style="color:var(--seiryu-blue); font-size:0.5rem;">${h.d}</div>å•: ${h.q}<br>ç­”: ${h.a}</div>`).join('');
    }
    function drawLucky() { playP(); addB("ä»Šæ—¥ã®å›ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¨ãƒŠã‚¸ãƒ¼ã¯â€¦ã€Œ"+['äºº ğŸ‘¤','è¾² ğŸŒ±','æ™ºæ…§ ğŸ’¡','å ´ ğŸ '][Math.floor(Math.random()*4)]+"ã€ã ã‚ˆï¼", 'ryuo'); }

    function render() {
        const m=document.getElementById('map-area'); if(m) m.innerHTML='';
        const g=document.getElementById('list-give'); if(g) g.innerHTML='';
        const w=document.getElementById('list-want'); if(w) w.innerHTML='';
        db.filter(i=>activeL.includes(i.type)).forEach(i=>{
            if(m){
                const n=document.createElement('div'); n.className=`node node--scale node--${i.type}`;
                n.style.top=i.y+'%'; n.style.left=i.x+'%'; n.innerHTML=i.icon; m.appendChild(n);
            }
            const c=document.createElement('div'); c.className='item-card'; c.style.borderLeftColor=`var(--${i.type})`;
            c.innerHTML=`<strong>${i.icon} ${i.title}</strong><br>${i.desc}`;
            if(i.mode==='give'){if(g)g.appendChild(c)}else{if(w)w.appendChild(c)}
        });
    }
</script>
</body>
</html>
