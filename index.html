<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENE-LOG - The Perfect Integration</title>
    <style>
        :root {
            --seiryu-blue: #00e5ff; --deep-blue: #001a33;
            --person: #e91e63; --agri: #4CAF50; --skill: #673AB7; --space: #FF9800;
            --header-h: 60px; --nav-h: 75px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; font-family: 'Hiragino Mincho ProN', serif; overflow: hidden; background: #000; }

        /* --- Layers --- */
        #setup-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
        header { position: fixed; top: 0; width: 100%; height: var(--header-h); background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 3000; }
        
        .view { display: none; width: 100%; height: calc(100vh - var(--nav-h)); position: absolute; top: 0; left: 0; overflow-y: auto; background: #f0f4f8; }
        .view.active { display: block; }

        /* --- Map & Layer Buttons --- */
        #home-view { background: #07192f url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&q=80&w=2000') center/cover; }
        .layer-side-nav { position: absolute; right: 15px; top: 80px; display: flex; flex-direction: column; gap: 10px; z-index: 3500; }
        .side-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; color: white; font-size: 0.7rem; font-weight: bold; display: flex; align-items: center; justify-content: center; opacity: 0.4; transition: 0.3s; }
        .side-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 0 15px var(--seiryu-blue); }

        /* --- Nodes (é±—ã¨é¡”) --- */
        .node { position: absolute; transform: translate(-50%, -50%); transition: 0.4s; }
        .node--person { width: 50px; height: 50px; border-radius: 50%; border: 3px solid var(--person); overflow: hidden; background: white; }
        .node--person img { width: 100%; height: 100%; object-fit: cover; }
        .node--scale { width: 44px; height: 48px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }

        /* --- Table (æ¨ªä¸¦ã³å¼·åˆ¶) --- */
        .table-flex { display: flex; height: 100%; padding: 70px 10px 10px; gap: 10px; }
        .table-col { flex: 1; background: rgba(255,255,255,0.7); border-radius: 15px; padding: 10px; overflow-y: auto; }

        /* --- Input Modal (å†™çœŸã‚¹ãƒšãƒ¼ã‚¹ä»˜) --- */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 8000; display: none; align-items: center; justify-content: center; }
        .modal-inner { width: 90%; background: white; border-radius: 20px; padding: 20px; }
        .photo-space { width: 100%; height: 120px; border: 2px dashed #ccc; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 0.7rem; color: #999; }

        /* --- KUKAI (ä¿®æ­£ç‰ˆ) --- */
        #ryuo-view { background: #000; flex-direction: column; }
        .chat-container { height: calc(100% - 140px); padding: 80px 20px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .kukai-footer { position: fixed; bottom: 90px; width: 92%; left: 4%; background: rgba(0,40,80,0.9); border: 1px solid var(--seiryu-blue); border-radius: 30px; display: flex; padding: 5px; z-index: 4500; }
        #kukai-input { flex: 1; background: none; border: none; color: white; padding: 10px; font-size: 1rem; outline: none; }

        /* --- Brave Gate (å¾©æ—§) --- */
        #gate-view { position: fixed; inset: 0; z-index: 9000; display: none; background: #000; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        #particle-canvas { position: absolute; inset: 0; pointer-events: none; }

        /* --- Footer --- */
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-h); background: var(--deep-blue); display: flex; align-items: center; z-index: 5000; padding-bottom: 15px; }
        .nav-btn { flex: 1; color: white; border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; opacity: 0.4; }
        .nav-btn.active { opacity: 1; color: var(--seiryu-blue); }
    </style>
</head>
<body>

    <div id="setup-layer" onclick="initApp()"><div><div style="font-size:50px;">ğŸ²</div><p>ENE-LOG èµ·å‹•</p></div></div>

    <div id="home-view" class="view active">
        <div class="layer-side-nav">
            <div class="side-btn active" style="background:var(--person)" onclick="toggleL('person',this)">äºº</div>
            <div class="side-btn active" style="background:var(--agri)" onclick="toggleL('agri',this)">è¾²</div>
            <div class="side-btn active" style="background:var(--skill)" onclick="toggleL('skill',this)">æ™ºæ…§</div>
            <div class="side-btn active" style="background:var(--space)" onclick="toggleL('space',this)">å ´</div>
        </div>
        <div id="map-area" style="width:100%; height:100%;"></div>
    </div>

    <div id="table-view" class="view">
        <div class="table-flex">
            <div class="table-col"><strong>ğŸ¥˜ æŒã¡å¯„ã‚Š</strong><div id="list-give"></div></div>
            <div class="table-col"><strong>ğŸ½ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</strong><div id="list-want"></div></div>
        </div>
    </div>

    <div id="ryuo-view" class="view">
        <button onclick="goMap()" style="position:fixed; top:75px; left:15px; z-index:5000; background:var(--seiryu-blue); border:none; padding:5px 15px; border-radius:15px; font-size:0.7rem; font-weight:bold;">ğŸ  Mapæˆ»ã‚‹</button>
        <div class="chat-container" id="chat-box"></div>
        <div class="kukai-footer">
            <button onclick="drawLucky()" style="background:none; border:none; color:var(--seiryu-blue); padding:0 10px;">å </button>
            <input type="text" id="kukai-input" placeholder="å•ã„ã‚’è¨˜å…¥..." onkeypress="if(event.key==='Enter') sendKukai()">
            <button onclick="sendKukai()" style="background:var(--seiryu-blue); border:none; width:40px; height:40px; border-radius:50%;">å•</button>
        </div>
    </div>

    <div id="gate-view">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="particle-canvas"></canvas>
        <button onclick="exitGate()" style="position:absolute; top:30px; left:20px; background:rgba(0,0,0,0.5); color:white; border:1px solid var(--seiryu-blue); padding:10px 20px; border-radius:20px;">â†© Mapæˆ»ã‚‹</button>
        <div id="kanji-output" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:80px; color:white; text-shadow:0 0 20px var(--seiryu-blue);"></div>
        <div style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); width:80px; height:80px; border-radius:50%; border:5px solid white;" onclick="observe()"></div>
    </div>

    <div id="modal">
        <div class="modal-inner">
            <div class="photo-space" onclick="alert('ã‚«ãƒ¡ãƒ©èµ·å‹•')">ğŸ“· å†™çœŸã‚’è²¼ã‚Šä»˜ã‘</div>
            <input type="text" id="in-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <textarea id="in-desc" placeholder="è©³ç´°"></textarea>
            <button onclick="saveItem()" style="width:100%; padding:15px; background:var(--deep-blue); color:white; border-radius:30px;">ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç½®ã</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; margin-top:10px; border:none; background:none; color:#999;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="switchView('home-view', this)">ğŸ—º<span>Map</span></button>
        <button class="nav-btn" onclick="switchView('table-view', this)">ğŸ¥˜<span>Table</span></button>
        <button class="nav-btn" onclick="switchView('ryuo-view', this)">ğŸ²<span>KUKAI</span></button>
        <button class="nav-btn" onclick="enterGate()">â›©<span>Gate</span></button>
    </nav>

    <button id="fab" style="position:fixed; bottom:95px; right:20px; width:60px; height:60px; background:var(--seiryu-blue); border-radius:50%; font-size:30px; z-index:4000;" onclick="document.getElementById('modal').style.display='flex'">ï¼‹</button>

<script>
    let audioCtx, activeL=['person','agri','skill','space'];
    let db = [
        { type:'person', icon:'ğŸ‘¤', title:'èŒ‚è°· å¹¸å¼˜', x:25, y:35, mode:'give', img:'https://i.pravatar.cc/150?u=shigetani' },
        { type:'agri', icon:'ğŸŒ±', title:'ç´è±†èŒå®Ÿé¨“', x:60, y:50, mode:'want' }
    ];

    function initApp() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); document.getElementById('setup-layer').style.display='none'; render(); }
    
    function switchView(id, btn) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('fab').style.display = (id==='home-view' || id==='table-view') ? 'block' : 'none';
    }

    function goMap() { switchView('home-view', document.querySelectorAll('.nav-btn')[0]); }

    function toggleL(type, btn) {
        if(activeL.includes(type)) activeL=activeL.filter(l=>l!==type); else activeL.push(type);
        btn.classList.toggle('active'); render();
    }

    async function enterGate() {
        document.getElementById('gate-view').style.display='block';
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById('webcam').srcObject = s;
    }

    function exitGate() {
        document.getElementById('gate-view').style.display='none';
        const s = document.getElementById('webcam').srcObject; if(s) s.getTracks().forEach(t=>t.stop());
        goMap();
    }

    function render() {
        const m = document.getElementById('map-area'); m.innerHTML = '';
        db.filter(i=>activeL.includes(i.type)).forEach(i=>{
            const n = document.createElement('div');
            if(i.type==='person'){
                n.className='node node--person'; n.innerHTML=`<img src="${i.img}">`;
            } else {
                n.className='node node--scale'; n.style.background=`var(--${i.type})`; n.innerText=i.icon;
            }
            n.style.top=i.y+'%'; n.style.left=i.x+'%'; m.appendChild(n);
        });
    }

    function sendKukai() {
        const i=document.getElementById('kukai-input'), t=i.value; if(!t)return;
        const b=document.getElementById('chat-box');
        b.innerHTML+=`<div class="bubble-user">${t}</div>`; i.value='';
        setTimeout(()=> { b.innerHTML+=`<div class="bubble-ryuo">å›ã®å•ã„ãŒã€æ–°ã—ã„æ³¢ç´‹ã‚’åºƒã’ãŸã‚ˆã€‚</div>`; b.scrollTop=b.scrollHeight; }, 1000);
    }
</script>
</body>
</html>
