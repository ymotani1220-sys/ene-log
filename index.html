<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENE-LOG - Auto Fade & Map Return</title>
    <style>
        :root {
            --seiryu-blue: #00e5ff;
            --deep-blue: #001a33;
            --agri: #4CAF50;
            --header-height: 60px;
            --nav-height: 75px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; font-family: 'Hiragino Mincho ProN', serif; overflow: hidden; background: #000; }

        /* --- UI Layers --- */
        header { 
            position: fixed; top: 0; width: 100%; height: var(--header-height); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; z-index: 3000; border-bottom: 1px solid #ddd;
        }
        .view { display: none; width: 100%; height: calc(100vh - var(--header-height) - var(--nav-height)); margin-top: var(--header-height); position: relative; background: #f0f4f8; }
        .view.active { display: block; }

        #home-view { background: #07192f url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&q=80&w=2000') center/cover; }

        /* --- Brave Gate (AR) --- */
        #gate-view { background: #000; margin: 0; height: 100vh; width: 100%; position: fixed; top: 0; z-index: 5000; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #particle-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        
        .back-btn { 
            position: absolute; top: 30px; left: 20px; z-index: 6000; 
            background: rgba(0,0,0,0.5); color: white; border: 1px solid var(--seiryu-blue);
            padding: 10px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem;
        }

        #kotodama-container { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        .kanji-word { font-size: 100px; color: white; text-shadow: 0 0 20px var(--seiryu-blue); opacity: 0; }
        
        @keyframes kanjiResonance {
            0% { opacity: 0; transform: scale(0.5); filter: blur(10px); }
            20% { opacity: 1; transform: scale(1.1); filter: blur(0); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.4); filter: blur(15px); }
        }

        /* Áã¨Ëá™„É°„ÉÉ„Çª„Éº„Ç∏Ôºà„Ç™„Éº„Éà„Éï„Çß„Éº„ÉâÂØæÂøúÔºâ */
        #custom-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; background: rgba(0, 26, 51, 0.95);
            border: 2px solid var(--seiryu-blue); border-radius: 20px;
            padding: 25px; color: white; text-align: center;
            z-index: 7000; display: none; opacity: 0; transition: opacity 0.5s;
            backdrop-filter: blur(15px);
        }

        .shutter-btn { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; border-radius: 50%; border: 5px solid #fff; background: rgba(255,255,255,0.2); z-index: 6000; }

        /* --- Global Nav --- */
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: var(--deep-blue); display: flex; align-items: center; z-index: 4000; padding-bottom: 10px; }
        .nav-btn { flex: 1; color: white; border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; opacity: 0.5; }
        .nav-btn.active { opacity: 1; color: var(--seiryu-blue); }
        
        #setup-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
    </style>
</head>
<body>

    <div id="setup-layer" onclick="setupAudio()">
        <div><div style="font-size: 50px;">üêâ</div><p>„Çø„ÉÉ„Éó„Åó„Å¶ÈñÄ„ÇíÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</p></div>
    </div>

    <div id="custom-alert">
        <h3 style="color:var(--seiryu-blue);">„Éî„ÉÅ„É£„Éº„É≥ÔºÅ</h3>
        <p>Êñ∞„Åó„ÅÑÊô∫ÊÖß„ÇíË¶≥Ê∏¨„Åó„Åæ„Åó„Åü„ÄÇ</p>
    </div>

    <header id="main-header">
        <div style="font-weight:bold; font-size:0.8rem;">üí† ENE-LOG</div>
    </header>

    <div id="home-view" class="view active">
        <div id="map-area" style="width:100%; height:100%;"></div>
    </div>

    <div id="table-view" class="view">
        <div style="padding:20px; text-align:center;">Table Data Loading...</div>
    </div>

    <div id="gate-view">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="particle-canvas"></canvas>
        <div class="back-btn" onclick="forceReturnToMap()">‚Ü©Ô∏è Map</div>
        <div id="kotodama-container"><div id="kanji-output" class="kanji-word"></div></div>
        <div class="shutter-btn" onclick="observe()"></div>
    </div>

    <nav id="main-nav">
        <button class="nav-btn active" id="map-nav-btn" onclick="forceReturnToMap()">üó∫<span>Map</span></button>
        <button class="nav-btn" onclick="switchView('table-view', this)">ü•ò<span>Table</span></button>
        <button class="nav-btn" onclick="enterGate()">‚õ©<span>Gate</span></button>
    </nav>

<script>
    let audioCtx;
    let isObserving = false;

    function setupAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        document.getElementById('setup-layer').style.display = 'none';
    }

    // ÂøÖ„Åö„Éû„ÉÉ„Éó„Å´Êàª„Çã„Åü„ÇÅ„ÅÆÈñ¢Êï∞
    function forceReturnToMap() {
        // ÂÖ®„Å¶„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        closeGate();
        closeAlert();
        resetKanji();
        
        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('home-view').classList.add('active');
        
        // „Éä„Éì„Éú„Çø„É≥„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíMap„Å´Âº∑Âà∂
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('map-nav-btn').classList.add('active');
    }

    function switchView(id, btn) {
        if (id === 'home-view') { forceReturnToMap(); return; }
        closeGate();
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function enterGate() {
        resetKanji();
        document.getElementById('gate-view').style.display = 'block';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('webcam').srcObject = stream;
            resize();
        } catch(e) { console.error(e); }
    }

    function closeGate() {
        document.getElementById('gate-view').style.display = 'none';
        const stream = document.getElementById('webcam').srcObject;
        if (stream) stream.getTracks().forEach(t => t.stop());
    }

    function resetKanji() {
        const kOut = document.getElementById('kanji-output');
        kOut.style.animation = 'none';
        kOut.style.opacity = '0';
        kOut.innerText = '';
        particles = [];
        if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height);
        isObserving = false;
    }

    function playSound(freq, type, dur) {
        if(!audioCtx) return;
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(now + dur);
    }

    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    class Particle {
        constructor(a, rs) { this.a = a; this.r = 0; this.rs = rs; this.l = 1.0; }
        update() { this.a += 0.25; this.r += this.rs; this.l -= 0.015; }
        draw() {
            ctx.beginPath(); ctx.arc(canvas.width/2 + Math.cos(this.a)*this.r, canvas.height/2 + Math.sin(this.a)*this.r, 3, 0, Math.PI*2);
            ctx.fillStyle = `hsla(185, 100%, 75%, ${this.l})`; ctx.fill();
        }
    }

    function animate() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles = particles.filter(p=>p.l>0);
        particles.forEach(p=>{ p.update(); p.draw(); });
        if(particles.length > 0) requestAnimationFrame(animate);
    }

    function observe() {
        if(isObserving) return;
        isObserving = true;
        playSound(200, 'triangle', 2.5);
        for(let i=0; i<80; i++) setTimeout(() => { particles.push(new Particle(i*0.2, 3+Math.random()*2)); if(i===0) animate(); }, i*8);
        const kOut = document.getElementById('kanji-output');
        kOut.innerText = ["Èæç", "Èüø", "Áîü", "ËÄï", "Áµê", "Èñã"][Math.floor(Math.random()*6)];
        kOut.style.animation = 'kanjiResonance 2.8s forwards';
        
        setTimeout(() => { 
            playSound(1200, 'sine', 0.8); 
            showAutoAlert();
        }, 2200);
    }

    function showAutoAlert() {
        const alertBox = document.getElementById('custom-alert');
        alertBox.style.display = 'block';
        setTimeout(() => { alertBox.style.opacity = '1'; }, 10);
        
        // 2ÁßíÂæå„Å´Ëá™Âãï„ÅßÊ∂à„Åô
        setTimeout(() => {
            closeAlert();
        }, 2000);
    }

    function closeAlert() {
        const alertBox = document.getElementById('custom-alert');
        alertBox.style.opacity = '0';
        setTimeout(() => { 
            alertBox.style.display = 'none'; 
            isObserving = false; // Ê¨°„ÅÆË¶≥Ê∏¨„ÇíÂèØËÉΩ„Å´„Åô„Çã
        }, 500);
    }
</script>
</body>
</html>
