<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENE-LOG - Pure Origin</title>
    <style>
        :root {
            --seiryu-blue: #00e5ff; --deep-blue: #001a33;
            --person: #e91e63; --agri: #4CAF50; --skill: #673AB7; --space: #FF9800;
            --header-h: 60px; --nav-h: 75px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; font-family: 'Hiragino Mincho ProN', serif; overflow: hidden; background: #000; }

        /* --- UI Framework --- */
        #setup-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
        
        header { 
            position: fixed; top: 0; width: 100%; height: var(--header-h); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; z-index: 3000; border-bottom: 1px solid #ddd;
        }

        .view { display: none; width: 100%; height: calc(100vh - var(--nav-h)); position: absolute; top: 0; left: 0; background: #f0f4f8; overflow-y: auto; }
        .view.active { display: block; }

        /* --- Map View (å¾©å…ƒ) --- */
        #home-view { background: #07192f url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&q=80&w=2000') center/cover; }
        .layer-side-nav { position: absolute; right: 15px; top: 80px; display: flex; flex-direction: column; gap: 12px; z-index: 3500; }
        .side-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; color: white; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; opacity: 0.4; background: rgba(0,0,0,0.5); transition: 0.3s; }
        .side-btn.active { opacity: 1; border-color: var(--seiryu-blue); box-shadow: 0 0 15px var(--seiryu-blue); transform: scale(1.1); }

        .node { position: absolute; transform: translate(-50%, -50%); transition: 0.4s; }
        .node--person { width: 55px; height: 55px; border-radius: 50%; border: 3px solid var(--person); overflow: hidden; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .node--person img { width: 100%; height: 100%; object-fit: cover; }
        .node--scale { width: 44px; height: 48px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }

        /* --- Table View (æ¨ªä¸¦ã³) --- */
        .table-flex { display: flex; height: 100%; padding: 75px 10px 10px; gap: 10px; }
        .table-col { flex: 1; background: rgba(255,255,255,0.7); border-radius: 15px; padding: 12px; overflow-y: auto; }
        .item-card { background: white; border-radius: 10px; padding: 10px; margin-bottom: 10px; border-left: 5px solid #ccc; font-size: 0.75rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- KUKAI View (å®‰å®šç‰ˆ) --- */
        #ryuo-view { background: radial-gradient(circle at center, #001a33 0%, #000 100%); display: flex; flex-direction: column; align-items: center; padding-top: 80px; }
        .wisdom-box { width: 90%; background: rgba(255,255,255,0.08); border-radius: 20px; border: 1px solid var(--seiryu-blue); padding: 25px; margin-top: 20px; color: white; font-size: 0.9rem; line-height: 1.8; }
        .kukai-input-box { position: fixed; bottom: 90px; width: 92%; display: flex; gap: 8px; background: rgba(0,40,80,0.9); border: 1px solid var(--seiryu-blue); border-radius: 30px; padding: 5px; }
        #kukai-input { flex: 1; background: none; border: none; color: white; padding: 10px 15px; outline: none; }

        /* --- Brave Gate --- */
        #gate-view { position: fixed; inset: 0; z-index: 9000; display: none; background: #000; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        #particle-canvas { position: absolute; inset: 0; pointer-events: none; }

        /* --- Footer Nav --- */
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-h); background: var(--deep-blue); display: flex; align-items: center; z-index: 5000; padding-bottom: 15px; }
        .nav-btn { flex: 1; color: white; border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; opacity: 0.4; }
        .nav-btn.active { opacity: 1; color: var(--seiryu-blue); }
        #fab { position: fixed; bottom: 95px; right: 20px; width: 60px; height: 60px; background: var(--seiryu-blue); border-radius: 50%; font-size: 30px; z-index: 4000; border:none; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* --- Modal (å†™çœŸæ ) --- */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 8000; display: none; align-items: center; justify-content: center; }
        .modal-inner { width: 90%; max-width: 400px; background: white; border-radius: 25px; padding: 20px; }
        .photo-area { width: 100%; height: 100px; border: 2px dashed #ccc; border-radius: 10px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div id="setup-layer" onclick="initApp()"><div><div style="font-size:50px; margin-bottom:15px;">ğŸ²</div><p>ENE-LOG èµ·å‹•</p></div></div>

    <header>
        <div style="font-weight:bold; font-size:0.8rem; color:var(--deep-blue);">ğŸ’  ENE-LOG</div>
        <button onclick="goMap()" style="background:none; border:1px solid var(--seiryu-blue); color:var(--seiryu-blue); padding:4px 12px; border-radius:15px; font-size:0.6rem;">ğŸ  Mapæˆ»ã‚‹</button>
    </header>

    <div id="home-view" class="view active">
        <div class="layer-side-nav">
            <div class="side-btn active" style="background:var(--person)" onclick="toggleL('person',this)">äºº</div>
            <div class="side-btn active" style="background:var(--agri)" onclick="toggleL('agri',this)">è¾²</div>
            <div class="side-btn active" style="background:var(--skill)" onclick="toggleL('skill',this)">æ™ºæ…§</div>
            <div class="side-btn active" style="background:var(--space)" onclick="toggleL('space',this)">å ´</div>
        </div>
        <div id="map-area" style="width:100%; height:100%;"></div>
    </div>

    <div id="table-view" class="view">
        <div class="table-flex">
            <div class="table-col"><strong style="font-size:0.7rem;">ğŸ¥˜ æŒã¡å¯„ã‚Š</strong><div id="list-give"></div></div>
            <div class="table-col"><strong style="font-size:0.7rem;">ğŸ½ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</strong><div id="list-want"></div></div>
        </div>
    </div>

    <div id="ryuo-view" class="view">
        <div style="font-size:50px;">ğŸ²</div>
        <div class="wisdom-box" id="wisdom-text">
            ã‚„ã‚ã€‚å›ãŒè¦³æ¸¬ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã€æ±åºƒå³¶ã®æœªæ¥ã‚’å½¢ä½œã£ã¦ã„ãã‚ˆã€‚ä»Šæ—¥ã¯ã©ã‚“ãªç™ºè¦‹ãŒã‚ã£ãŸã‹ãªï¼Ÿ
        </div>
        <div class="kukai-input-box">
            <button onclick="drawLucky()" style="background:none; border:none; color:var(--seiryu-blue); padding:0 15px;">å </button>
            <input type="text" id="kukai-input" placeholder="KUKAIã«å•ã„ã‹ã‘ã‚‹..." onkeypress="if(event.key==='Enter') sendKukai()">
            <button onclick="sendKukai()" style="background:var(--seiryu-blue); border:none; width:40px; height:40px; border-radius:50%; font-weight:bold;">å•</button>
        </div>
    </div>

    <div id="gate-view">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="particle-canvas"></canvas>
        <button onclick="exitGate()" style="position:absolute; top:30px; left:20px; background:rgba(0,0,0,0.5); color:white; border:1px solid var(--seiryu-blue); padding:10px 20px; border-radius:20px; font-size:0.8rem;">â†© Mapæˆ»ã‚‹</button>
        <div id="kanji-output" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:80px; color:white; text-shadow:0 0 20px var(--seiryu-blue);"></div>
        <div style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); width:80px; height:80px; border-radius:50%; border:5px solid white;" onclick="observe()"></div>
    </div>

    <div id="modal">
        <div class="modal-inner">
            <div class="photo-area">ğŸ“· å†™çœŸã‚’è²¼ã‚Šä»˜ã‘</div>
            <input type="text" id="in-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <textarea id="in-desc" placeholder="è©³ç´°"></textarea>
            <button onclick="saveItem()" style="width:100%; padding:15px; background:var(--deep-blue); color:white; border-radius:30px; border:none; font-weight:bold;">ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç½®ã</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; margin-top:10px; border:none; background:none; color:#999;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="switchView('home-view', this)">ğŸ—º<span>Map</span></button>
        <button class="nav-btn" onclick="switchView('table-view', this)">ğŸ¥˜<span>Table</span></button>
        <button class="nav-btn" onclick="switchView('ryuo-view', this)">ğŸ²<span>KUKAI</span></button>
        <button class="nav-btn" onclick="enterGate()">â›©<span>Gate</span></button>
    </nav>

    <button id="fab" onclick="document.getElementById('modal').style.display='flex'">ï¼‹</button>

<script>
    let audioCtx, activeL=['person','agri','skill','space'];
    let db = [
        { type:'person', icon:'ğŸ‘¤', title:'èŒ‚è°· å¹¸å¼˜', x:25, y:35, mode:'give', img:'https://i.pravatar.cc/150?u=shigetani' },
        { type:'agri', icon:'ğŸŒ±', title:'ç´è±†èŒå®Ÿé¨“', x:60, y:50, mode:'give' },
        { type:'skill', icon:'ğŸ’¡', title:'ARè¦³æ¸¬', x:40, y:20, mode:'want' }
    ];

    function initApp() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); document.getElementById('setup-layer').style.display='none'; render(); }
    
    function switchView(id, btn) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('fab').style.display = (id==='home-view' || id==='table-view') ? 'block' : 'none';
        render();
    }

    function goMap() { switchView('home-view', document.querySelectorAll('.nav-btn')[0]); }

    function toggleL(type, btn) {
        if(activeL.includes(type)) activeL=activeL.filter(l=>l!==type); else activeL.push(type);
        btn.classList.toggle('active'); render();
    }

    async function enterGate() {
        document.getElementById('gate-view').style.display='block';
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById('webcam').srcObject = s;
    }

    function exitGate() {
        document.getElementById('gate-view').style.display='none';
        const s = document.getElementById('webcam').srcObject; if(s) s.getTracks().forEach(t=>t.stop());
        goMap();
    }

    function render() {
        const m = document.getElementById('map-area'); m.innerHTML = '';
        const listG = document.getElementById('list-give'); listG.innerHTML = '';
        const listW = document.getElementById('list-want'); listW.innerHTML = '';

        db.filter(i=>activeL.includes(i.type)).forEach(i=>{
            const n = document.createElement('div');
            if(i.type==='person'){
                n.className='node node--person'; n.innerHTML=`<img src="${i.img}">`;
            } else {
                n.className='node node--scale'; n.style.background=`var(--${i.type})`; n.innerText=i.icon;
            }
            n.style.top=i.y+'%'; n.style.left=i.x+'%'; m.appendChild(n);

            const card = document.createElement('div'); card.className='item-card';
            card.innerHTML = `<strong>${i.icon} ${i.title}</strong>`;
            if(i.mode==='give') listG.appendChild(card); else listW.appendChild(card);
        });
    }

    function sendKukai() {
        const i=document.getElementById('kukai-input'), t=i.value; if(!t)return;
        document.getElementById('wisdom-text').innerText = "ãã®å•ã„ã€é¢ç™½ã„ã­ã€‚å›ãŒè¦³æ¸¬ã—ãŸã“ã¨ã§ã€æ–°ã—ã„ç¾å®Ÿã®æ³¢ç´‹ãŒåºƒãŒã£ãŸã‚ˆã€‚";
        i.value='';
    }
    
    function drawLucky() {
        const res = ['äºº ğŸ‘¤','è¾² ğŸŒ±','æ™ºæ…§ ğŸ’¡','å ´ ğŸ '][Math.floor(Math.random()*4)];
        document.getElementById('wisdom-text').innerText = `ä»Šæ—¥ã®å›ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¨ãƒŠã‚¸ãƒ¼ã¯ã€Œ${res}ã€ã ã‚ˆï¼`;
    }
</script>
</body>
</html>
