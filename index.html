<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENE-LOG - The Final Resonance</title>
    <style>
        :root {
            --seiryu-blue: #00e5ff; --deep-blue: #001a33;
            --agri: #4CAF50; --skill: #673AB7; --space: #FF9800; --person: #e91e63;
            --header-h: 60px; --nav-h: 75px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; font-family: 'Hiragino Mincho ProN', serif; overflow: hidden; background: var(--deep-blue); }

        /* --- UI Layers --- */
        #setup-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
        header { position: fixed; top: 0; width: 100%; height: var(--header-h); background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 3000; border-bottom: 1px solid #ddd; }
        
        .view { display: none; width: 100%; height: calc(100vh - var(--header-h) - var(--nav-h)); margin-top: var(--header-h); position: relative; overflow-y: auto; background: #f0f4f8; }
        .view.active { display: block; }

        /* --- Map & Nodes --- */
        #home-view { background: #07192f url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&q=80&w=2000') center/cover; }
        .side-btns { position: absolute; right: 15px; top: 80px; display: flex; flex-direction: column; gap: 10px; z-index: 3500; }
        .side-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; color: white; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; opacity: 0.4; background: rgba(0,0,0,0.5); }
        .side-btn.active { opacity: 1; border-color: var(--seiryu-blue); box-shadow: 0 0 15px var(--seiryu-blue); }

        .node { position: absolute; transform: translate(-50%, -50%); transition: 0.4s; }
        .node--person { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; background-size: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .node--scale { width: 44px; height: 48px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }

        /* --- Table --- */
        .table-flex { display: flex; padding: 15px; gap: 10px; height: 100%; }
        .table-col { flex: 1; background: rgba(255,255,255,0.7); border-radius: 15px; padding: 12px; overflow-y: auto; }
        .card { background: white; padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #ccc; font-size: 0.7rem; }

        /* --- KUKAI (Stability Focused) --- */
        #ryuo-view { background: radial-gradient(circle at center, #002b55 0%, #000 100%); display: flex; flex-direction: column; }
        #k-chat { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 120px; }
        .b-k { align-self: flex-start; max-width: 85%; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 12px; color: white; font-size: 0.85rem; border: 1px solid rgba(0,229,255,0.2); }
        .b-u { align-self: flex-end; max-width: 80%; background: var(--seiryu-blue); color: var(--deep-blue); border-radius: 15px; padding: 10px; font-size: 0.85rem; font-weight: bold; }
        .k-input-wrap { position: absolute; bottom: 20px; width: 92%; left: 4%; background: rgba(0,40,80,0.95); border: 1px solid var(--seiryu-blue); border-radius: 30px; display: flex; padding: 5px; z-index: 4000; backdrop-filter: blur(10px); }
        #k-field { flex: 1; background: none; border: none; color: white; padding: 10px; font-size: 1rem; outline: none; }

        /* --- Brave Gate (Observation Logic) --- */
        #gate-view { position: fixed; inset: 0; z-index: 9000; display: none; background: #000; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        #particle-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        .kanji-word { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 100px; color: white; text-shadow: 0 0 20px var(--seiryu-blue); opacity: 0; pointer-events: none; z-index: 10; }
        
        @keyframes kanjiRes { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); filter: blur(10px); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); filter: blur(0); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.4); filter: blur(15px); }
        }

        /* --- Footer & FAB --- */
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-h); background: var(--deep-blue); display: flex; align-items: center; z-index: 4000; padding-bottom: 15px; }
        .nav-btn { flex: 1; color: white; border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; opacity: 0.4; }
        .nav-btn.active { opacity: 1; color: var(--seiryu-blue); }
        #fab { position: fixed; bottom: 95px; right: 20px; width: 60px; height: 60px; background: var(--seiryu-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 3500; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* --- Modal --- */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 8000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-inner { width: 90%; max-width: 400px; background: white; border-radius: 25px; padding: 20px; }
        .photo-box { width: 100%; height: 100px; border: 2px dashed #ccc; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div id="setup-layer" onclick="initApp()"><div><div style="font-size: 50px; margin-bottom: 20px;">üêâ</div><p>„Çø„ÉÉ„Éó„Åó„Å¶ÈñÄ„ÇíÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</p></div></div>

    <header>
        <div style="font-weight:bold; font-size:0.8rem; color:var(--deep-blue);">üí† ENE-LOG</div>
        <button onclick="goHome()" style="background:none; border:1px solid var(--seiryu-blue); color:var(--seiryu-blue); padding:4px 12px; border-radius:15px; font-size:0.6rem;">üè† MapÊàª„Çã</button>
    </header>

    <div id="home-view" class="view active">
        <div class="side-btns">
            <div class="side-btn active" style="background:var(--person)" onclick="toggleL('person',this)">‰∫∫</div>
            <div class="side-btn active" style="background:var(--agri)" onclick="toggleL('agri',this)">Ëæ≤</div>
            <div class="side-btn active" style="background:var(--skill)" onclick="toggleL('skill',this)">Êô∫ÊÖß</div>
            <div class="side-btn active" style="background:var(--space)" onclick="toggleL('space',this)">Â†¥</div>
        </div>
        <div id="map-area" style="width:100%; height:100%;"></div>
    </div>

    <div id="table-view" class="view">
        <div class="table-flex">
            <div class="table-col"><strong style="font-size:0.7rem;">ü•ò ÊåÅ„Å°ÂØÑ„Çä</strong><div id="l-give"></div></div>
            <div class="table-col"><strong style="font-size:0.7rem;">üçΩ „É™„ÇØ„Ç®„Çπ„Éà</strong><div id="l-want"></div></div>
        </div>
    </div>

    <div id="ryuo-view" class="view">
        <div id="k-chat"><div class="b-k">„ÇÑ„ÅÇ„ÄÇ‰Ωï„ÅãÂïè„ÅÑ„ÇíÊäï„Åí„Å¶„Åî„Çâ„Çì„ÄÇ</div></div>
        <div class="k-input-wrap">
            <button onclick="drawLucky()" style="background:none; border:none; color:var(--seiryu-blue); padding:0 15px;">Âç†</button>
            <input type="text" id="k-field" placeholder="KUKAI„Å´Ë©±„Åó„Åã„Åë„Çã..." onkeypress="if(event.key==='Enter') sendK()">
            <button onclick="sendK()" style="background:var(--seiryu-blue); border:none; width:40px; height:40px; border-radius:50%; font-weight:bold;">Âïè</button>
        </div>
    </div>

    <div id="gate-view">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="particle-canvas"></canvas>
        <button onclick="exitGate()" style="position:absolute; top:30px; left:20px; background:rgba(0,0,0,0.5); border:1px solid var(--seiryu-blue); color:white; padding:10px 20px; border-radius:20px; font-size:0.7rem;">‚Ü© Map„Å´Êàª„Çã</button>
        <div id="kanji-output" class="kanji-word"></div>
        <div style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); width:80px; height:80px; border-radius:50%; border:5px solid white;" onclick="observe()"></div>
    </div>

    <div id="modal">
        <div class="modal-inner">
            <div class="photo-box">üì∏ ÂÜôÁúü„ÇíË≤º„Çä‰ªò„Åë</div>
            <input type="text" id="in-title" placeholder="„Çø„Ç§„Éà„É´">
            <textarea id="in-desc" placeholder="Ë©≥Á¥∞"></textarea>
            <button onclick="save()" style="width:100%; padding:15px; background:var(--deep-blue); color:white; border-radius:30px; border:none; font-weight:bold;">„ÉÜ„Éº„Éñ„É´„Å∏ÁΩÆ„Åè</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; background:none; border:none; color:#999; margin-top:10px;">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <button id="fab" onclick="document.getElementById('modal').style.display='flex'">Ôºã</button>

    <nav>
        <button class="nav-btn active" onclick="switchV('home-view', this)">üó∫<span>Map</span></button>
        <button class="nav-btn" onclick="switchV('table-view', this)">ü•ò<span>Table</span></button>
        <button class="nav-btn" onclick="switchV('ryuo-view', this)">üê≤<span>KUKAI</span></button>
        <button class="nav-btn" onclick="enterGate()">‚õ©<span>Gate</span></button>
    </nav>

<script>
    let audioCtx, activeL=['person','agri','skill','space'], isObs = false;
    let db = [
        { type:'person', icon:'üë§', title:'ËåÇË∞∑ Âπ∏Âºò', x:25, y:35, mode:'give', img:'https://i.pravatar.cc/150?u=shigetani' },
        { type:'agri', icon:'üå±', title:'Á¥çË±ÜËèåÂÆüÈ®ì', x:60, y:50, mode:'give' }
    ];

    function initApp() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); document.getElementById('setup-layer').style.display='none'; render(); }
    function goHome() { switchV('home-view', document.querySelectorAll('.nav-btn')[0]); }
    function switchV(id, btn) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('fab').style.display = (id==='ryuo-view')?'none':'block';
        render();
    }

    function playP() {
        const n=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(1100,n); o.frequency.exponentialRampToValueAtTime(1700,n+0.05);
        g.gain.setValueAtTime(0.4,n); g.gain.exponentialRampToValueAtTime(0.001,n+0.8);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(n+0.8);
    }

    function toggleL(t, b) {
        if(activeL.includes(t)) activeL=activeL.filter(l=>l!==t); else activeL.push(t);
        b.classList.toggle('active'); render();
    }

    // --- Brave Gate: Automatic Reset Logic ---
    async function enterGate() {
        document.getElementById('gate-view').style.display='block';
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById('webcam').srcObject = s; canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    }
    function exitGate() {
        document.getElementById('gate-view').style.display='none';
        const s = document.getElementById('webcam').srcObject; if(s) s.getTracks().forEach(t=>t.stop());
        goHome();
    }
    function observe() {
        if(isObs) return; isObs = true; playP();
        for(let i=0; i<80; i++) setTimeout(() => { particles.push(new Particle(i*0.2, 3+Math.random()*2)); if(i===0) animate(); }, i*8);
        const k = document.getElementById('kanji-output');
        k.innerText = ["Èæç", "Èüø", "Áîü", "ËÄï", "Áµê", "Èñã"][Math.floor(Math.random()*6)];
        k.style.animation = 'kanjiRes 1.2s forwards';

        // 1ÁßíÂº∑Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæåÔºâ„ÅßËá™Âãï„É™„Çª„ÉÉ„Éà
        setTimeout(() => {
            k.innerText = "";
            k.style.animation = "none";
            isObs = false;
        }, 1300);
    }

    function sendK() {
        const i=document.getElementById('k-field'), t=i.value; if(!t)return;
        playP(); addB(t,'u'); i.value='';
        setTimeout(()=> { addB("„Åù„ÅÆÂïè„ÅÑ„ÄÅÈù¢ÁôΩ„ÅÑ„Å≠„ÄÇÂêõ„ÅÆË¶≥Ê∏¨„ÅßÊñ∞„Åó„ÅÑÊ≥¢Á¥ã„ÅåÂ∫É„Åå„Å£„Åü„Çà„ÄÇ", 'k'); }, 1000);
    }
    function addB(t,type) { const b=document.getElementById('k-chat'), d=document.createElement('div'); d.className=type==='u'?'b-u':'b-k'; d.innerText=t; b.appendChild(d); b.scrollTop=b.scrollHeight; }
    function drawLucky() { playP(); addB("‰ªäÊó•„ÅÆ„É©„ÉÉ„Ç≠„Éº„Ç®„Éä„Ç∏„Éº„ÅØ‚Ä¶„Äå"+['‰∫∫ üë§','Ëæ≤ üå±','Êô∫ÊÖß üí°','Â†¥ üè†'][Math.floor(Math.random()*4)]+"„Äç„Å†„ÇàÔºÅ", 'k'); }

    function render() {
        const m = document.getElementById('map-area'); m.innerHTML = '';
        const g = document.getElementById('l-give'); g.innerHTML = '';
        const w = document.getElementById('l-want'); w.innerHTML = '';
        db.filter(i=>activeL.includes(i.type)).forEach(i=>{
            const n = document.createElement('div');
            if(i.type==='person'){ n.className='node node--person'; n.innerHTML=`<img src="${i.img}">`; }
            else { n.className='node node--scale'; n.style.background=`var(--${i.type})`; n.innerText=i.icon; }
            n.style.top=i.y+'%'; n.style.left=i.x+'%'; m.appendChild(n);
            const card = document.createElement('div'); card.className='card'; card.style.borderLeftColor=`var(--${i.type})`;
            card.innerHTML=`<strong>${i.icon} ${i.title}</strong>`;
            if(i.mode==='give') g.appendChild(card); else w.appendChild(card);
        });
    }

    const canvas = document.getElementById('particle-canvas'), ctx = canvas.getContext('2d'); let particles = [];
    class Particle { constructor(a,rs){this.a=a;this.r=0;this.rs=rs;this.l=1.0;} update(){this.a+=0.25;this.r+=this.rs;this.l-=0.015;} draw(){ctx.beginPath();ctx.arc(canvas.width/2+Math.cos(this.a)*this.r,canvas.height/2+Math.sin(this.a)*this.r,2.5,0,Math.PI*2);ctx.fillStyle=`hsla(185,100%,75%,${this.l})`;ctx.fill();} }
    function animate() { ctx.clearRect(0,0,canvas.width,canvas.height); particles=particles.filter(p=>p.l>0); particles.forEach(p=>{p.update();p.draw();}); if(particles.length>0)requestAnimationFrame(animate); }
</script>
</body>
</html>
