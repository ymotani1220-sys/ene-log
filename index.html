<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENE-LOG - Circular Input System</title>
    <style>
        :root {
            --seiryu-blue: #00e5ff;
            --deep-blue: #001a33;
            --agri: #4CAF50;
            --skill: #673AB7;
            --space: #FF9800;
            --person: #e91e63;
            --header-height: 60px;
            --nav-height: 75px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; font-family: 'Hiragino Mincho ProN', serif; overflow: hidden; background: var(--deep-blue); }

        /* --- UI Layers --- */
        header { 
            position: fixed; top: 0; width: 100%; height: var(--header-height); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; z-index: 3000; border-bottom: 1px solid #ddd;
        }
        .layer-bar { display: flex; gap: 6px; overflow-x: auto; padding: 5px; }
        .layer-chip { padding: 4px 10px; border-radius: 12px; border: 1px solid #ccc; background: white; font-size: 0.6rem; font-weight: bold; cursor: pointer; transition: 0.3s; white-space: nowrap; }
        .layer-chip.active { color: white; border-color: transparent; }
        .c--person.active { background: var(--person); } .c--agri.active { background: var(--agri); } .c--skill.active { background: var(--skill); } .c--space.active { background: var(--space); }

        .view { display: none; width: 100%; height: calc(100vh - var(--header-height) - var(--nav-height)); margin-top: var(--header-height); position: relative; overflow-y: auto; background: #f0f4f8; }
        .view.active { display: block; }

        /* --- Map & Table --- */
        #home-view { background: #07192f url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&q=80&w=2000') center/cover; }
        .node { position: absolute; transform: translate(-50%, -50%); transition: 0.4s; }
        .node--person { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; background-size: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .node--scale { width: 44px; height: 48px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        
        .table-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .table-col { background: rgba(255,255,255,0.7); border-radius: 15px; padding: 10px; min-height: 400px; }
        .item-card { background: white; border-radius: 10px; padding: 10px; margin-bottom: 8px; border-left: 4px solid #ccc; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .item-card img { width: 100%; border-radius: 5px; margin-top: 5px; display: none; }

        /* --- Input Modal --- */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 8000; backdrop-filter: blur(8px); }
        .modal-inner { width: 90%; max-width: 400px; background: white; border-radius: 25px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        
        /* æŒã¡å¯„ã‚Š/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .mode-switch { display: flex; background: #eee; border-radius: 20px; margin-bottom: 15px; padding: 3px; }
        .mode-btn { flex: 1; border: none; padding: 8px; border-radius: 18px; font-size: 0.75rem; font-weight: bold; background: none; color: #666; cursor: pointer; transition: 0.3s; }
        .mode-btn.active { background: white; color: var(--deep-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .sphere-sel { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .sphere-btn { width: 42px; height: 42px; border-radius: 50%; border: 2px solid transparent; color: white; font-size: 0.6rem; opacity: 0.3; transition: 0.3s; }
        .sphere-btn.selected { opacity: 1; border-color: #333; transform: scale(1.1); }

        input, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 0.9rem; }
        
        /* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .photo-upload { width: 100%; height: 80px; border: 2px dashed #ccc; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; margin-bottom: 15px; font-size: 0.7rem; cursor: pointer; position: relative; overflow: hidden; }
        #photo-preview { position: absolute; width: 100%; height: 100%; object-fit: cover; display: none; }

        /* --- Brave Gate (AR) --- */
        #gate-view { background: #000; position: fixed; inset: 0; z-index: 5000; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #particle-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        .kanji-word { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 100px; color: white; text-shadow: 0 0 20px var(--seiryu-blue); opacity: 0; z-index: 10; pointer-events: none; }
        @keyframes kanjiResonance {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.4); }
        }
        .shutter-btn { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; border-radius: 50%; border: 5px solid #fff; background: rgba(255,255,255,0.2); z-index: 6000; }
        #custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 260px; background: rgba(0,26,51,0.95); border: 2px solid var(--seiryu-blue); border-radius: 20px; padding: 20px; color: white; text-align: center; z-index: 7000; display: none; transition: 0.5s; }

        /* --- Nav & FAB --- */
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: var(--deep-blue); display: flex; align-items: center; z-index: 4000; padding-bottom: 10px; }
        .nav-btn { flex: 1; color: white; border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; opacity: 0.4; }
        .nav-btn.active { opacity: 1; color: var(--seiryu-blue); }
        .fab { position: fixed; bottom: 95px; right: 20px; width: 60px; height: 60px; background: var(--seiryu-blue); border-radius: 50%; border: none; font-size: 30px; z-index: 3500; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: var(--deep-blue); font-weight: bold; }
        
        #setup-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
    </style>
</head>
<body>

    <div id="setup-layer" onclick="setupAudio()">
        <div><div style="font-size: 50px;">ğŸ‰</div><p>ã‚¿ãƒƒãƒ—ã—ã¦é–€ã‚’é–‹ã„ã¦ãã ã•ã„</p></div>
    </div>

    <div id="modal">
        <div class="modal-inner">
            <h3 style="text-align:center; font-size:0.9rem; margin-bottom:15px;">æ–°ã—ã„å…±é³´ã‚’è¨˜éŒ²ã™ã‚‹</h3>
            
            <div class="mode-switch">
                <button id="mode-give" onclick="setMode('give')" class="mode-btn active">ğŸ¥˜ æŒã¡å¯„ã‚Š</button>
                <button id="mode-want" onclick="setMode('want')" class="mode-btn">ğŸ½ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
            </div>

            <div class="sphere-sel">
                <button id="s-person" onclick="setSphere('person','ğŸ‘¤')" class="sphere-btn selected" style="background:var(--person);">äºº</button>
                <button id="s-agri" onclick="setSphere('agri','ğŸŒ±')" class="sphere-btn" style="background:var(--agri);">è¾²</button>
                <button id="s-skill" onclick="setSphere('skill','ğŸ’¡')" class="sphere-btn" style="background:var(--skill);">æ™ºæ…§</button>
                <button id="s-space" onclick="setSphere('space','ğŸ ')" class="sphere-btn" style="background:var(--space);">å ´</button>
            </div>

            <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
                <span id="upload-label">ğŸ“¸ å†™çœŸã‚’è¿½åŠ ã™ã‚‹</span>
                <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="previewPhoto(this)">
                <img id="photo-preview">
            </div>

            <input type="text" id="m-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: è‡ªå®¶è£½ã‚³ãƒ¼ãƒ’ãƒ¼ã®æœ¨)">
            <textarea id="m-desc" rows="2" placeholder="è©³ç´°ã‚„æƒ³ã„ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..."></textarea>
            
            <button onclick="saveData()" style="width:100%; padding:15px; background:var(--deep-blue); color:white; border:none; border-radius:30px; font-weight:bold; margin-top:5px;">ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç½®ã</button>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#999; margin-top:10px; font-size:0.75rem;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="custom-alert">
        <h3 style="color:var(--seiryu-blue);">ãƒ”ãƒãƒ£ãƒ¼ãƒ³ï¼</h3>
        <p>æ–°ã—ã„æ™ºæ…§ã‚’è¦³æ¸¬ã—ã¾ã—ãŸã€‚</p>
    </div>

    <header id="main-header">
        <div style="font-weight:bold; font-size:0.6rem; margin-left:10px; color:#333;">ğŸ’  ENE-LOG</div>
        <div class="layer-bar">
            <div class="layer-chip active c--person" onclick="toggleLayer('person', this)">ğŸ‘¤ äºº</div>
            <div class="layer-chip active c--agri" onclick="toggleLayer('agri', this)">ğŸŒ± è¾²</div>
            <div class="layer-chip active c--skill" onclick="toggleLayer('skill', this)">ğŸ’¡ æ™ºæ…§</div>
            <div class="layer-chip active c--space" onclick="toggleLayer('space', this)">ğŸ  å ´</div>
        </div>
    </header>

    <div id="home-view" class="view active">
        <div id="map-area" style="width:100%; height:100%;"></div>
    </div>

    <div id="table-view" class="view">
        <div class="table-container">
            <div class="table-col">
                <div style="font-size:0.7rem; font-weight:bold; margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">ğŸ¥˜ æŒã¡å¯„ã‚Š</div>
                <div id="off-list"></div>
            </div>
            <div class="table-col">
                <div style="font-size:0.7rem; font-weight:bold; margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">ğŸ½ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
                <div id="req-list"></div>
            </div>
        </div>
    </div>

    <div id="ryuo-view" class="view">
        <div style="padding:40px; text-align:center;">
            <div style="font-size:50px;">ğŸ²</div>
            <h3 style="color:var(--deep-blue);">é¾ç‹ã®æ™ºæ…§</h3>
            <p style="font-size:0.75rem; color:#666; margin-top:20px;">ã‚ãªãŸã®è“„ç©ã—ãŸã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’<br>é¾ç‹ãŒèª­ã¿è§£ã„ã¦ã„ã¾ã™...</p>
        </div>
    </div>

    <div id="gate-view">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="particle-canvas"></canvas>
        <div style="position:absolute; top:30px; left:20px; color:white; border:1px solid var(--seiryu-blue); padding:5px 15px; border-radius:20px; font-size:0.7rem;" onclick="forceReturnToMap()">â†©ï¸ Map</div>
        <div id="kotodama-container"><div id="kanji-output" class="kanji-word"></div></div>
        <div class="shutter-btn" onclick="observe()"></div>
    </div>

    <button class="fab" onclick="openModal()">ï¼‹</button>

    <nav id="main-nav">
        <button class="nav-btn active" id="map-nav-btn" onclick="switchView('home-view', this)">ğŸ—º<span>Map</span></button>
        <button class="nav-btn" onclick="switchView('table-view', this)">ğŸ¥˜<span>Table</span></button>
        <button class="nav-btn" onclick="switchView('ryuo-view', this)">ğŸ²<span>é¾ç‹</span></button>
        <button class="nav-btn" onclick="enterGate()">â›©<span>Gate</span></button>
    </nav>

<script>
    let audioCtx;
    let isObserving = false;
    let mCat = 'person', mIcon = 'ğŸ‘¤', mMode = 'give', mImg = null;
    let activeLayers = ['person', 'agri', 'skill', 'space'];
    let db = [
        { type:'person', icon:'ğŸ‘¤', title:'èŒ‚è°· å¹¸å¼˜', x:25, y:35, mode:'give', img:'https://i.pravatar.cc/150?u=shige', desc:'Tableæ¡ˆå†…äºº' },
        { type:'agri', icon:'ğŸŒ±', title:'ç´è±†èŒå®Ÿé¨“ä¸­', x:60, y:50, mode:'want', desc:'åŠ¹æœæ¸¬å®šã®å”åŠ›æ±‚ã‚€' }
    ];

    function setupAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        document.getElementById('setup-layer').style.display = 'none';
        render();
    }

    function switchView(id, btn) {
        closeGate();
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'home-view' || id === 'table-view') render();
    }

    function forceReturnToMap() {
        switchView('home-view', document.getElementById('map-nav-btn'));
    }

    // --- Modal Logic ---
    function openModal() { document.getElementById('modal').style.display = 'flex'; }
    function closeModal() { 
        document.getElementById('modal').style.display = 'none';
        mImg = null; 
        document.getElementById('photo-preview').style.display = 'none';
        document.getElementById('upload-label').style.display = 'block';
    }

    function setMode(mode) {
        mMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
    }

    function setSphere(cat, icon) {
        mCat = cat; mIcon = icon;
        document.querySelectorAll('.sphere-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('s-'+cat).classList.add('selected');
    }

    function previewPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                mImg = e.target.result;
                const preview = document.getElementById('photo-preview');
                preview.src = mImg;
                preview.style.display = 'block';
                document.getElementById('upload-label').style.display = 'none';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveData() {
        const title = document.getElementById('m-title').value;
        const desc = document.getElementById('m-desc').value;
        if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        db.unshift({ 
            type: mCat, icon: mIcon, title, desc, mode: mMode, img: mImg,
            x: 20+Math.random()*60, y: 20+Math.random()*60 
        });
        
        document.getElementById('m-title').value = '';
        document.getElementById('m-desc').value = '';
        closeModal(); render();
    }

    function toggleLayer(type, btn) {
        if(activeLayers.includes(type)) activeLayers = activeLayers.filter(l => l !== type);
        else activeLayers.push(type);
        btn.classList.toggle('active');
        render();
    }

    // --- AR / Gate Logic ---
    async function enterGate() {
        document.getElementById('gate-view').style.display = 'block';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('webcam').srcObject = stream;
            resize();
        } catch(e) { console.error(e); }
    }
    function closeGate() {
        document.getElementById('gate-view').style.display = 'none';
        const stream = document.getElementById('webcam').srcObject;
        if (stream) stream.getTracks().forEach(t => t.stop());
    }

    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    class Particle {
        constructor(a, rs) { this.a = a; this.r = 0; this.rs = rs; this.l = 1.0; }
        update() { this.a += 0.25; this.r += this.rs; this.l -= 0.015; }
        draw() {
            ctx.beginPath(); ctx.arc(canvas.width/2 + Math.cos(this.a)*this.r, canvas.height/2 + Math.sin(this.a)*this.r, 2.5, 0, Math.PI*2);
            ctx.fillStyle = `hsla(185, 100%, 75%, ${this.l})`; ctx.fill();
        }
    }
    function animate() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles = particles.filter(p=>p.l>0);
        particles.forEach(p=>{ p.update(); p.draw(); });
        if(particles.length > 0) requestAnimationFrame(animate);
    }
    function observe() {
        if(isObserving) return;
        isObserving = true;
        for(let i=0; i<80; i++) setTimeout(() => { particles.push(new Particle(i*0.2, 3+Math.random()*2)); if(i===0) animate(); }, i*8);
        const kOut = document.getElementById('kanji-output');
        kOut.innerText = ["é¾", "éŸ¿", "ç”Ÿ", "è€•", "çµ", "é–‹"][Math.floor(Math.random()*6)];
        kOut.style.animation = 'kanjiResonance 2.8s forwards';
        setTimeout(() => { 
            const alertBox = document.getElementById('custom-alert');
            alertBox.style.display = 'block'; setTimeout(() => alertBox.style.opacity = '1', 10);
            setTimeout(() => { alertBox.style.opacity = '0'; setTimeout(() => { alertBox.style.display = 'none'; isObserving = false; }, 500); }, 2000);
        }, 2100);
    }

    // --- Rendering ---
    function render() {
        const mapArea = document.getElementById('map-area');
        if(mapArea) mapArea.innerHTML = '';
        const offList = document.getElementById('off-list');
        const reqList = document.getElementById('req-list');
        if(offList) offList.innerHTML = '';
        if(reqList) reqList.innerHTML = '';

        const filtered = db.filter(item => activeLayers.includes(item.type));
        
        filtered.forEach(item => {
            // Map Rendering
            if(mapArea) {
                const el = document.createElement('div');
                el.className = (item.type === 'person' && item.img) ? 'node node--person' : `node node--scale node--${item.type}`;
                if(item.type === 'person' && item.img) el.style.backgroundImage = `url('${item.img}')`;
                else el.innerHTML = item.icon;
                el.style.top = item.y + '%'; el.style.left = item.x + '%';
                mapArea.appendChild(el);
            }

            // Table Rendering
            const card = document.createElement('div');
            card.className = 'item-card';
            card.style.borderLeftColor = `var(--${item.type})`;
            let imgHtml = item.img ? `<img src="${item.img}" style="display:block">` : '';
            card.innerHTML = `<strong>${item.icon} ${item.title}</strong><br>${item.desc || ''}${imgHtml}`;
            
            if(item.mode === 'give') { if(offList) offList.appendChild(card); }
            else { if(reqList) reqList.appendChild(card); }
        });
    }
    window.onload = resize;
</script>
</body>
</html>
